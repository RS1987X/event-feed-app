# Alert Feedback System

## Overview

The feedback system allows users to rate signal alerts (e.g., earnings guidance) for correctness and provide detailed metadata about what was wrong. Feedback is stored in GCS for later analysis during model evaluation and retraining.

## Architecture

```
Alert generated by detector
    ↓
Alert payload saved to GCS:
  gs://event-feed-app-data/feedback/alert_payloads/signal_type=guidance_change/2025-11-12.jsonl
    ↓
User receives Telegram alert
    ↓
Clicks link: https://pr-viewer.run.app/?id=<pr_id>&alert_id=<alert_id>&signal_type=guidance_change
    ↓
Streamlit web viewer loads:
    - Press release content from GCS (silver_normalized/table=press_releases)
    - Alert payload from GCS (feedback/alert_payloads/) → Shows what system detected
    - Existing feedback from GCS (feedback/signal_ratings/)
    ↓
User compares detected vs actual content
    ↓
User submits feedback (✅ Correct or ❌ Incorrect with details)
    ↓
Feedback saved to: gs://event-feed-app-data/feedback/signal_ratings/signal_type=<type>/YYYY-MM-DD.jsonl
```

## GCS Storage Structure

```
gs://event-feed-app-data/
└── feedback/
    ├── alert_payloads/          ← What the system detected (for comparison)
    │   └── signal_type=guidance_change/
    │       ├── 2025-11-12.jsonl
    │       └── 2025-11-13.jsonl
    └── signal_ratings/           ← User feedback on correctness
        └── signal_type=guidance_change/
            ├── 2025-11-12.jsonl
            └── 2025-11-13.jsonl
```

## Feedback Schema

### Alert Payload (What System Detected)

Stored in `feedback/alert_payloads/signal_type=<type>/YYYY-MM-DD.jsonl`:

```json
{
  "alert_id": "alert_abc123def456",
  "alert_type": "guidance_change",
  "press_release_id": "1980c93f9f819a6d",
  "company_name": "Acme Corp",
  "detected_at": "2025-11-12T10:00:00Z",
  "significance_score": 0.85,
  "guidance_count": 2,
  "guidance_items": [
    {
      "metric": "revenue",
      "direction": "up",
      "period": "Q4_2025",
      "value_str": "$100M → $120M (+20%)",
      "confidence": 0.92,
      "text_snippet": "we now expect revenue of $120M, up from prior guidance of $100M"
    },
    {
      "metric": "eps",
      "direction": "up",
      "period": "Q4_2025",
      "value_str": "$1.50 → $1.80 (+20%)",
      "confidence": 0.88,
      "text_snippet": "EPS guidance raised to $1.80"
    }
  ],
  "metadata": {
    "press_release_url": "https://pr-viewer.run.app/?id=1980c93f",
    "release_date": "2025-11-12",
    "period": "Q4_2025"
  }
}
```

### User Feedback (Correctness Rating)

Stored in `feedback/signal_ratings/signal_type=<type>/YYYY-MM-DD.jsonl`:

### Core Fields (all signal types)

```json
{
  "feedback_id": "fb_abc123def456",
  "signal_type": "guidance_change",
  "signal_id": "alert_xyz789",
  "press_release_id": "1980c93f9f819a6d",
  "user_id": "user_iphone",
  "is_correct": false,
  "feedback_type": "wrong_metric",
  "submitted_at": "2025-11-12T14:30:00Z",
  "metadata": {},
  "notes": "Detected revenue but should have been margin"
}
```

### Guidance-Specific Metadata

For `signal_type=guidance_change`, the `metadata` field contains:

```json
{
  "metadata": {
    "issue_type": "wrong_metric",
    "correct_metrics": ["margin", "ebitda"],
    "correct_direction": "down",
    "correct_period": "FY_2025",
    "guidance_type": "lower"
  }
}
```

**Available Fields:**
- `issue_type`: "false_positive", "wrong_metric", "wrong_direction", "wrong_period", "wrong_magnitude", "missed_context"
- `correct_metrics`: List of actual metrics mentioned (revenue, eps, ebit, ebitda, margin, capex, cash_flow, other)
- `correct_direction`: "up", "down", "unchanged", "mixed"
- `correct_period`: e.g., "Q4_2025", "FY_2025"
- `guidance_type`: "initiate", "update", "raise", "lower", "reaffirm", "withdraw"

## Usage

### 1. Web Viewer (End Users)

When users click alert links in Telegram, they see:
1. Full press release content
2. Quick feedback buttons (✅ Correct / ❌ Incorrect)
3. Detailed form for incorrect alerts (metrics, direction, period, notes)

URL format:
```
https://pr-viewer.run.app/?id=1980c93f&alert_id=alert_123&signal_type=guidance_change
```

### 2. Command-Line Scripts

**View feedback statistics:**
```bash
# All signal types
python scripts/view_feedback_stats.py

# Specific signal type
python scripts/view_feedback_stats.py --signal-type guidance_change
```

**Test feedback system:**
```bash
python scripts/test_feedback_system.py
```

### 3. Programmatic Access

```python
from event_feed_app.alerts.feedback_store import FeedbackStore

store = FeedbackStore()

# Save feedback
feedback_id = store.save_feedback(
    signal_type="guidance_change",
    signal_id="alert_xyz",
    press_release_id="1980c93f",
    user_id="analyst_1",
    is_correct=False,
    guidance_metadata={
        "issue_type": "wrong_metric",
        "correct_metrics": ["margin"],
        "correct_direction": "down"
    },
    notes="Missed the EBITDA margin guidance"
)

# Retrieve feedback
feedback = store.get_feedback_for_signal(
    signal_type="guidance_change",
    signal_id="alert_xyz"
)

# Get statistics
stats = store.get_feedback_stats(signal_type="guidance_change")
print(f"Accuracy: {stats['accuracy'] * 100:.1f}%")
```

## Analysis Workflow

### Loading Feedback for Model Evaluation

```python
import pandas as pd

# Load all guidance_change feedback
feedback_df = pd.read_json(
    "gs://event-feed-app-data/feedback/signal_ratings/signal_type=guidance_change/*.jsonl",
    lines=True
)

# Join with press releases
from event_feed_app.utils.io import load_from_gcs
prs_df = load_from_gcs("event-feed-app-data/silver_normalized/table=press_releases")

# Merge on press_release_id
merged = feedback_df.merge(prs_df, on="press_release_id", how="left")

# Analyze patterns
false_positives = merged[merged["is_correct"] == False]
print(f"Common false positive issues: {false_positives['metadata'].value_counts()}")
```

### Identifying Improvement Areas

```python
# What metrics are commonly misdetected?
wrong_metrics = feedback_df[
    feedback_df["metadata"].apply(lambda x: x.get("issue_type") == "wrong_metric")
]

# What types of guidance changes have low accuracy?
guidance_types = feedback_df["metadata"].apply(lambda x: x.get("guidance_type"))
accuracy_by_type = feedback_df.groupby(guidance_types)["is_correct"].mean()
```

## Future Signal Types

For planned signal types and development roadmap, see **[`SIGNAL_ROADMAP.md`](SIGNAL_ROADMAP.md)**.

### Adding New Signal Types

When adding new signal types (e.g., `mergers_acquisitions`):

1. Add signal type key to `significant_events.yaml`
2. Create partition in GCS: `signal_type=mergers_acquisitions/`
3. Add signal-specific metadata fields to web viewer form
4. Update this README with new schema fields
5. Add to signal roadmap document

## Deployment

The web viewer runs on Google Cloud Run:

```bash
# Deploy viewer
bash deploy_viewer.sh

# Set environment variable
export VIEWER_BASE_URL=https://pr-viewer-xyz.run.app

# Update .env file
echo "VIEWER_BASE_URL=https://pr-viewer-xyz.run.app" >> .env
```

## Cost

- **GCS storage**: ~$0.02/GB/month (expect <1GB for years of feedback)
- **Cloud Run**: ~$0.05/month for 70 views/month (see deployment docs)
- **BigQuery queries**: $5/TB scanned (rarely needed for this volume)

Total: **< $0.10/month**
